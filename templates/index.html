<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Analytics Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='dataTable.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-brand">
                <h1>Sales Data Dashboard</h1>
            </div>
            <div class="controls">
                <div class="control-group">
                    <label for="startDate">Start Date</label>
                    <input type="date" id="startDate" />
                </div>
                <div class="control-group">
                    <label for="endDate">End Date</label>
                    <input type="date" id="endDate" />
                </div>
                <div class="control-group">
                    <label for="repStatus">Rep Status</label>
                    <select id="repStatus">
                        <option value="1">Active</option>
                        <option value="0">Inactive</option>
                        <option value="All">All</option>
                    </select>
                </div>
                <button class="btn" onclick="loadData()">Load Data</button>
                <button class="btn btn-telephony" onclick="openTelephony()">Open Telephony Data</button>
                <button class="btn btn-green" onclick="exportTableToExcel()">Export to Excel</button>
                <button class="btn btn-green" onclick="exportTableToCSV()">Export to CSV</button>
                <button class="btn btn-analytics" onclick="openAnalytics()">üìä View Analytics</button>
            </div>
        </div>

        <div class="table-container">
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="Search for rep name...">
                <span class="search-icon">üîç</span>
            </div>
            <div class="table-wrapper">
                <div id="loadingMessage" class="loading">Loading data...</div>
                <table id="dataTable" style="display: none;">
                    <thead id="tableHeader"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="drillDownModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Detail View</h3>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        // -----------------------------
        // BASE_URL: dynamically reflects Flask app root
        // -----------------------------
        const BASE_URL = '{{ request.script_root }}' || '';

        let salesData = [];
        let filteredData = [];

        document.addEventListener('DOMContentLoaded', function() {
            function formatDateLocal(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);

            document.getElementById('startDate').value = formatDateLocal(firstDayOfMonth);
            document.getElementById('endDate').value = formatDateLocal(today);
            document.getElementById('repStatus').value = '1';

            loadData();

            document.getElementById('searchInput').addEventListener('input', filterData);
        });

        // -----------------------------
        // Load data from Flask API
        // -----------------------------
        async function loadData() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const repStatus = document.getElementById('repStatus').value;

            if (!startDate || !endDate) {
                alert('Please select both start and end dates');
                return;
            }

            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('dataTable').style.display = 'none';

            try {
                const response = await fetch(`${BASE_URL}/api/salesdata?start=${startDate}&end=${endDate}&rep=${repStatus}`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                salesData = await response.json();
                filteredData = [...salesData];

                if (salesData.length > 0) {
                    buildTable();
                } else {
                    document.getElementById('loadingMessage').innerHTML = '<div class="no-results">No data found for the selected criteria</div>';
                }
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingMessage').innerHTML = '<div class="no-results">Error loading data. Please check your connection and try again.</div>';
            }
        }

        // -----------------------------
        // Build table from filteredData
        // -----------------------------
        function buildTable() {
            if (filteredData.length === 0) {
                document.getElementById('loadingMessage').innerHTML = '<div class="no-results">No results found</div>';
                document.getElementById('dataTable').style.display = 'none';
                return;
            }

            const table = document.getElementById('dataTable');
            const header = document.getElementById('tableHeader');
            const body = document.getElementById('tableBody');

            header.innerHTML = '';
            body.innerHTML = '';

            const columns = [
                'RepName', 'TeamName', 'IsRep', 'SumGP', 'ReferralGP', 'Addition', 'Reversal', 'GPTotal', 
                'OverspendGP', 'DiscretionaryGP', 'OtherDisctrtionaryGP', 'MDMGP', 'FreshGP', 'BCADGP', 
                'FinalGPTotal', 'TotNew', 'TotResign', 'TotConnections', 'LL_SumGP', 'LL_Addition', 
                'LL_Reversal', 'LLOtherDisctrtionaryGP', 'GammaNewGP', 'GammaRSGP', 'iPecsNewGP', 
                'iPecsRSGP', '3CXNewGP', '3CXRSGP', 'Telephony_Undefined', 'LL_FinalGPTotal', 
                'Gamma_NEW_Seats', 'Gamma_RS_Seats', 'iPecs_NEW_Seats', 'iPecs_RS_Seats', '3CXNewSeats', 
                '3CXRSSeats', 'TotSeats', 'NoProviderGP', 'NoProviderDealAddition', 'NoProviderDealReversal', 
                'FinalNoProviderGP', 'BDSIT/ITHardwareOnlyGP', 'BDSIT_DealAddition', 'BDSIT_DealReversal', 
                'FinalBDSIT/ITHardwareOnly', 'OverallTotalGP'
            ];

            const headerRow = document.createElement('tr');
            columns.forEach(col => {
                const th = document.createElement('th');
                th.textContent = col;
                headerRow.appendChild(th);
            });
            header.appendChild(headerRow);

            filteredData.forEach(row => {
                const tr = document.createElement('tr');
                columns.forEach(col => {
                    const td = document.createElement('td');
                    const value = row[col];
                    td.textContent = (typeof value === 'number') ? value.toLocaleString() : value || '';

                    if (col === 'RepName') {
                        td.classList.add('rep-name-cell');
                        const tooltip = document.createElement('div');
                        tooltip.className = 'rep-name-tooltip';
                        tooltip.textContent = 'Click here to view detailed breakdown';
                        td.appendChild(tooltip);
                        td.addEventListener('click', () => showRepDrillDown(row));
                    }

                    tr.appendChild(td);
                });
                body.appendChild(tr);
            });

            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('dataTable').style.display = 'table';
        }

        // -----------------------------
        // Filter table
        // -----------------------------
        function filterData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            filteredData = searchTerm === '' 
                ? [...salesData] 
                : salesData.filter(row => row.RepName && row.RepName.toLowerCase().includes(searchTerm));
            buildTable();
        }

        // -----------------------------
        // Drill-down modal
        // -----------------------------
        function showRepDrillDown(row) {
            const modal = document.getElementById('drillDownModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');

            modalTitle.textContent = `Representative Overview - ${row.RepName}`;

// desde aqui
  // Create comprehensive rep overview
            let content = `
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #667eea; margin-bottom: 10px;">Representative Profile</h4>
                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 20px; border-radius: 12px;">
                        <h3 style="margin: 0 0 10px 0; font-size: 1.5rem;">${row.RepName}</h3>
                        <p style="margin: 5px 0;"><strong>Team:</strong> ${row.TeamName}</p>
                        <p style="margin: 5px 0;"><strong>Status:</strong> ${row.IsRep ? 'Active Representative' : 'Inactive'}</p>
                        <p style="margin: 5px 0;"><strong>Overall Total GP:</strong> ¬£${typeof row.OverallTotalGP === 'number' ? row.OverallTotalGP.toLocaleString() : row.OverallTotalGP}</p>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #667eea; margin-bottom: 10px;">Performance Summary</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div style="background: #e8f4f8; padding: 15px; border-radius: 10px; border-left: 4px solid #2596be;">
                            <h5 style="color: #14568d; margin-bottom: 8px;">Primary GP Metrics</h5>
                          <p><strong>Mob Tot. GP:</strong> ¬£${typeof row.FinalGPTotal === 'number' ? row.FinalGPTotal.toLocaleString() : row.FinalGPTotal}</p>
                            <p><strong>Tele. Tot. GP:</strong> ¬£${typeof row.LL_FinalGPTotal === 'number' ? row.LL_FinalGPTotal.toLocaleString() : row.LL_FinalGPTotal}</p>
                            <p><strong>No Prov. Tot. GP:</strong> ¬£${typeof row.FinalNoProviderGP === 'number' ? row.FinalNoProviderGP.toLocaleString() : row.FinalNoProviderGP}</p>
                            <p><strong>BDS IT Tot. GP:</strong> ¬£${typeof row['FinalBDSIT/ITHardwareOnly'] === 'number' ? row['FinalBDSIT/ITHardwareOnly'].toLocaleString() : row['FinalBDSIT/ITHardwareOnly']}</p>
                            <p><strong>Overall Total GP:</strong> ¬£${typeof row.OverallTotalGP === 'number' ? row.OverallTotalGP.toLocaleString() : row.OverallTotalGP}</p>
                        </div>
                        <div style="background: #f0f8e8; padding: 15px; border-radius: 10px; border-left: 4px solid #28a745;">
                            <h5 style="color: #1e7e34; margin-bottom: 8px;">Connection Stats</h5>
                                <p><strong>NEW:</strong> ${row.TotNew}</p>
                            <p><strong>RS:</strong> ${row.TotResign}</p>
                            <p><strong>Total Connections:</strong> ${row.TotConnections}</p>
                        </div>
                        <div style="background: #fff0f5; padding: 15px; border-radius: 10px; border-left: 4px solid #f093fb;">
                            <h5 style="color: #c73e91; margin-bottom: 8px;">Telephony</h5>
                              <p><strong>Gamma NEW:</strong> ${row.Gamma_NEW_Seats}</p>
                              <p><strong>Gamma RS:</strong> ${row.Gamma_RS_Seats}</p>
                               <p><strong>iPecs NEW:</strong> ${row.iPecs_NEW_Seats}</p>
                                <p><strong>iPecs RS:</strong> ${row.iPecs_RS_Seats}</p>
                                 <p><strong>3CX NEW:</strong> ${row['3CXNewSeats']}</p>
                                  <p><strong>3CX RS:</strong> ${row['3CXRSSeats']}</p>
                            <p><strong>Total Seats:</strong> ${row.TotSeats}</p>
                            <p><strong>LL Final GP:</strong> ¬£${typeof row.LL_FinalGPTotal === 'number' ? row.LL_FinalGPTotal.toLocaleString() : row.LL_FinalGPTotal}</p>
                        </div>
                    </div>
                </div>

                <div>
                    <h4 style="color: #667eea; margin-bottom: 10px;">Detailed Metrics Breakdown</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 10px; max-height: 300px; overflow-y: auto;">
            `;

            // Add all metrics in smaller cards
            const allMetrics = [
                'SumGP','ReferralGP','Addition','Reversal','GPTotal','OverspendGP','DiscretionaryGP', 'OtherDisctrtionaryGP',
                'MDMGP','FreshGP','BCADGP','FinalGPTotal',  'TotNew', 'TotResign', 'TotConnections','LL_SumGP', 'LL_Addition',
                'LL_Reversal','LLOtherDisctrtionaryGP','GammaNewGP', 'GammaRSGP','iPecsNewGP', 'iPecsRSGP', '3CXNewGP','3CXRSGP',
                'Telephony_Undefined','LL_FinalGPTotal', 'Gamma_NEW_Seats', 'Gamma_RS_Seats','iPecs_NEW_Seats','iPecs_RS_Seats', 
                '3CXNewSeats', '3CXRSSeats',  'TotSeats','NoProviderGP','NoProviderDealAddition', 'NoProviderDealReversal',
                 'FinalNoProviderGP','BDSIT/ITHardwareOnlyGP', 'BDSIT_DealAddition','BDSIT_DealReversal', 
                'FinalBDSIT/ITHardwareOnly', 'OverallTotalGP'
            ];
            
            allMetrics.forEach(metric => {
                if (row[metric] !== undefined) {
                    const metricValue = typeof row[metric] === 'number' ? row[metric].toLocaleString() : row[metric];
                    
                    content += `
                        <div style="background: white; border: 1px solid #e1e5e9; padding: 10px; border-radius: 8px; text-align: center; transition: all 0.2s ease; cursor: pointer;" 
                             onclick="showDrillDown(${JSON.stringify(row).replace(/"/g, '&quot;')}, '${metric}', ${JSON.stringify(row[metric])})">
                            <div style="font-size: 0.7rem; margin-bottom: 4px; color: #666; font-weight: 500;">${metric}</div>
                            <div style="font-size: 0.9rem; font-weight: bold; color: #333;">${metricValue}</div>
                        </div>
                    `;
                }
            });

            content += `
                    </div>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: #f8fafc; border-radius: 10px; text-align: center; color: #666; font-size: 0.9rem;">
                    üí° Click on any metric above to see detailed breakdown
                </div>
            `;

            modalContent.innerHTML = content;
            modal.style.display = 'block';
        }

//hasta aqui

        function closeModal() {
            document.getElementById('drillDownModal').style.display = 'none';
        }

        window.addEventListener('click', e => {
            if (e.target === document.getElementById('drillDownModal')) closeModal();
        });

        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') closeModal();
        });

        // -----------------------------
        // Export functions
        // -----------------------------
        function exportTableToExcel() {
            const table = document.getElementById("dataTable");
            const wb = XLSX.utils.table_to_book(table, { sheet: "Sheet1" });
            XLSX.writeFile(wb, "sales_data.xlsx");
        }

        function exportTableToCSV() {
            const table = document.getElementById("dataTable");
            let csv = [];
            for (let row of table.rows) {
                let rowData = [];
                for (let cell of row.cells) {
                    rowData.push('"' + cell.innerText.replace(/"/g, '""') + '"');
                }
                csv.push(rowData.join(","));
            }
            const blob = new Blob([csv.join("\n")], { type: "text/csv" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "sales_data.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // -----------------------------
        // Analytics
        // -----------------------------
        function openAnalytics() {
            const analyticsDataPackage = {
                data: filteredData,
                originalData: salesData,
                filters: {
                    startDate: document.getElementById('startDate').value,
                    endDate: document.getElementById('endDate').value,
                    repStatus: document.getElementById('repStatus').value
                },
                timestamp: new Date().toISOString()
            };
            alert('Analytics feature would open here with current data filters applied!');
            console.log('Analytics data package:', analyticsDataPackage);
        }

        //---------------
        //TELEPHONY DATA
        //---------------
        function loadTelephonyData() {
            const telephonyDataPackage = {
                data: filteredData,
                originalData: salesData,
                filters: {
                    startDate: document.getElementById('startDate').value,
                    endDate: document.getElementById('endDate').value,                 
                },
                timestamp: new Date().toISOString()
            };
            alert('Telephony data feature would open here with current data filters applied!');
            console.log('Telephony data package:', telephonyDataPackage);
        }
function openTelephony() {
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;
    window.open(`/telephony?start=${start}&end=${end}`, '_blank');
}

    </script>
</body>
</html>
