<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telephony Analytics Details Data</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='dataTable.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
              <img src="{{ url_for('static', filename='Barclay Digital Services Logo Full Colour.png') }}" alt="Barclay Digital Services" class="company-logo">
            <h1>Telephony Analytics Details Data</h1>
            <div class="controls">
                <label>Start Date <input type="date" id="startDate"></label>
                <label>End Date <input type="date" id="endDate"></label>
                <button class="btn" onclick="loadTelephonyDetails()">Refresh</button>                
                 <button class="btn btn-green" onclick="exportTableToExcel()">Export to Excel</button>
                <button class="btn btn-green" onclick="exportTableToCSV()">Export to CSV</button>
                <button class="btn btn-goback" onclick="goBackToDashboard()">Previous Page</button>
            </div>
        </div>

        <div class="table-container">
            <div id="loadingMessage" class="loading">Loading data...</div>
            <table id="dataTable" style="display: none;">
                <thead id="tableHeader"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        const BASE_URL = '{{ request.script_root }}' || '';

        let salesData = [];
        let filteredData = [];

        document.addEventListener('DOMContentLoaded', function() {

            function formatDateLocal(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);

             document.getElementById('startDate').value = formatDateLocal(firstDay);
            document.getElementById('endDate').value = formatDateLocal(today);

            loadTelephonyDetails();
        });

        async function loadTelephonyDetails() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            document.getElementById('loadingMessage').style.display = 'block';
            document.getElementById('dataTable').style.display = 'none';

            try {
                const response = await fetch(`${BASE_URL}/api/telephonyDetails?start=${startDate}&end=${endDate}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                salesData = await response.json();
                filteredData = [...salesData];

                if (salesData.length > 0) {
                    buildTableTelephonyDetails();
                } else {
                    document.getElementById('loadingMessage').innerText = "No data found";
                }
            } catch (err) {
                console.error(err);
                document.getElementById('loadingMessage').innerText = "Error loading data";
            }
        }

        // Build table from filteredData with fixed column order
        function buildTableTelephonyDetails() {
            if (filteredData.length === 0) {
                document.getElementById('loadingMessage').innerHTML = '<div class="no-results">No results found</div>';
                document.getElementById('dataTable').style.display = 'none';
                return;
            }

            const header = document.getElementById('tableHeader');
            const body = document.getElementById('tableBody');
            header.innerHTML = '';
            body.innerHTML = '';

            const columns = [
                'DealRep','DealNumber','DealCustomerAccountNumber','CustomerAccountName','Gamma_NEW_Seats','Gamma_RS_Seats',
                'iPecs_NEW_Seats','iPecs_RS_Seats','3CXNewSeats','3CXRSSeats','TotSeats','Gamma_NEW_GP','Gamma_RS_GP',
                'iPECS_NEW_GP','iPECS_RS_GP','3CX_NEW_GP','3CX_RS_GP','Undefined_GP','DealTotalGP','DealStatus',
                'CustomerOrderNumber','SageInvoiceDate','CRMOpportunityID','DealCompleteNotes'

            ];

            const headerRow = document.createElement('tr');
            columns.forEach(col => {
                const th = document.createElement('th');
                th.textContent = col;
                headerRow.appendChild(th);
            });
            header.appendChild(headerRow);

            filteredData.forEach(row => {
                const tr = document.createElement('tr');
                columns.forEach(col => {
                    const td = document.createElement('td');
                    const value = row[col];
                    td.textContent = (typeof value === 'number') ? value.toLocaleString() : value || '';

                    if (col === 'DealRep') {
                        td.classList.add('rep-name-cell');
                        const tooltip = document.createElement('div');
                        tooltip.className = 'rep-name-tooltip';
                        tooltip.textContent = 'Click here to view detailed breakdown';
                        td.appendChild(tooltip);
                        td.addEventListener('click', () => showRepDrillDown(row));
                    }

                    tr.appendChild(td);
                });
                body.appendChild(tr);
            });

            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('dataTable').style.display = 'table';
        }

        function goBackToDashboard() {
            if (window.opener) {
                window.close();
            } else {
                window.location.href = '/';
            }
        }

        // -----------------------------
        // Export functions
        // -----------------------------
        function exportTableToExcel() {
            const table = document.getElementById("dataTable");
            const wb = XLSX.utils.table_to_book(table, { sheet: "Sheet1" });
            XLSX.writeFile(wb, "sales_data.xlsx");
        }

        function exportTableToCSV() {
            const table = document.getElementById("dataTable");
            let csv = [];
            for (let row of table.rows) {
                let rowData = [];
                for (let cell of row.cells) {
                    rowData.push('"' + cell.innerText.replace(/"/g, '""') + '"');
                }
                csv.push(rowData.join(","));
            }
            const blob = new Blob([csv.join("\n")], { type: "text/csv" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "sales_data.csv";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // placeholder if you want to add drilldowns later
        function showRepDrillDown(row) {
            alert("Drilldown for rep: " + (row.RepName || row.DealRep));
        }

         //---------------
        //TELEPHONY DATA
        //---------------
        function debugTelephonyDetails() {
            const telephonyDataPackage = {
                data: filteredData,
                originalData: salesData,
                filters: {
                    startDate: document.getElementById('startDate').value,
                    endDate: document.getElementById('endDate').value,                 
                },
                timestamp: new Date().toISOString()
            };
            alert('Telephony data feature would open here with current data filters applied!');
            console.log('Telephony data package:', telephonyDataPackage);
        }
function openTelephonyDetails() {
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;
    window.open(`/telephonyDetails?start=${start}&end=${end}`, '_blank');
}



    </script>
</body>
</html>
